#asyn-exec-mq
消息队列是如今在分布式环境下使用最多的技术之一，通过消息队列，我们可以将
不同模块的业务进行异步、解耦、削峰。但是在分布式环境下，如果保证消息队列
的可靠性是一个值得我们重视的问题，在一些业务场景下，一条MQ消息丢失都有
可能会对系统的数据一致性造成影响，比如说订单，秒杀，积分这种数据较为
敏感的业务。所以我们就需要通过代码来保证消息队列的高可靠。

消息队列高可靠主要通过三个方面来实现

* 生产者确保消息发送成功
* 消息队列确保消息存储不丢失
* 消费者确保消息会被消费成功

## 生产者
对于生产者来说，可以通过以下两种方式的任一种，来保证消息发送成功。
### 失败重试
如果发送失败，就重试发送，注意，此处要注意重试的次数，如果一直重试，需要注意由于死循环导致的问题，
可能会导致服务线程数被打满，CPU利用率飙升等情况，同时，重试也会导致请求的响应时间变长，这在一些追求
快速响应的互联网产品下是一个较大的缺点。
### 消息归档
如果MQ发送成功，就将这条记录的消息状态改为发送成功；

如果MQ发送失败，就将这条记录的消息状态改为发送失败。

开启一个定时任务定时扫描库表，补偿发送MQ消息，
如果发送成功，就将这条消息的状态改为发送成功，否则就等待下次继续补偿发送。

通过补偿发送MQ消息的方式，保证MQ消息发送成功，也是一种常用的方式。

## 消息队列
通过合理的配置，来保证消息不丢，比如Kafka或者RocketMQ支持分布式集群部署，提高消息队列的高可靠、高可用。
## 消费者
对于消费者来说，需要做到以下两点，才能尽可能的保证数据一致性。
### ACK
消费者确认执行成功之后再返回ACK，否则就直接返回，通过这种方式，防止业务执行中出现了异常状况，
但是由于提前返回了ACK，导致该条消息从消息队列中移除，不会再被消费，导致该条消息对应
### 判重
为什么会出现重复消息？

由于分布式环境，网络并不一定保证畅通，所以此时有可能出现经典的网络二将军问题。

[两军问题](https://zh.m.wikipedia.org/zh-hans/%E4%B8%A4%E5%86%9B%E9%97%AE%E9%A2%98)

二将军问题：指通过消息通信的双方，如果A没有接收到B的回复，那么A将无法确定B是否
接收到了A发送的消息，于是A只能通过重试的方式来确保消息成功传输，如果此时B对于
这条消息的处理并不幂等，那么势必会造成数据一致性的问题。

* 由于网络问题，消息队列接收到了消息，但生产者认为发送失败，进行多次重复发送一条消息
* 由于网络问题，ACK并未被消息队列接收到，消费者重复消费了一条消息

## 选修课积分发放场景
我们通过一个简单的场景Demo，来实现我们通过消息队列异步解耦的功能。
### 场景介绍
选修课应该每一个人都经历过，当我们报名的选修课结束之后，我们可以获取对应的学分，如果不使用MQ，那么此处的业务流程是一个同步的
过程，课程结束 -> 学生积分发放，此处由于学生较多，一一发放的过程较慢，会造成该次调用响应很慢，所以我们通过MQ将其变成一个异步的过程。

### 流程图

